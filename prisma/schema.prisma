generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum ServiceType {
  MOVING
  DISPOSAL
  BOTH
}

enum SpeedType {
  ECONOMY
  STANDARD
  EXPRESS
}

enum OrderStatus {
  NEW
  REQUESTED
  CONFIRMED
  IN_PROGRESS
  DONE
  CANCELLED
}

enum PreferredTimeWindow {
  MORNING
  AFTERNOON
  EVENING
  FLEXIBLE
}

enum ContactPreference {
  PHONE
  WHATSAPP
  EMAIL
}

enum ServiceModuleSlug {
  MONTAGE
  ENTSORGUNG
  SPECIAL
}

enum ServiceOptionPricingType {
  FLAT
  PER_UNIT
  PER_M3
  PER_HOUR
}

enum PromoDiscountType {
  PERCENT
  FLAT_CENTS
}

model CatalogItem {
  id                  String   @id @default(cuid())
  slug                String   @unique
  categoryKey         String
  nameDe              String
  defaultVolumeM3     Float
  laborMinutesPerUnit Int
  isHeavy             Boolean  @default(false)
  sortOrder           Int      @default(0)
  active              Boolean  @default(true)
  deletedAt           DateTime?
  deletedBy           String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  orderLines OrderLine[]
}

model PricingConfig {
  id                                String   @id @default(cuid())
  active                            Boolean  @default(true)
  deletedAt                         DateTime?
  deletedBy                         String?
  currency                          String   @default("EUR")

  movingBaseFeeCents                Int
  disposalBaseFeeCents              Int
  hourlyRateCents                   Int
  perM3MovingCents                  Int
  perM3DisposalCents                Int
  perKmCents                        Int
  heavyItemSurchargeCents           Int
  stairsSurchargePerFloorCents      Int
  carryDistanceSurchargePer25mCents Int
  parkingSurchargeMediumCents       Int
  parkingSurchargeHardCents         Int
  elevatorDiscountSmallCents        Int
  elevatorDiscountLargeCents        Int

  uncertaintyPercent Int @default(12)

  economyMultiplier  Float
  standardMultiplier Float
  expressMultiplier  Float
  economyLeadDays    Int
  standardLeadDays   Int
  expressLeadDays    Int

  montageBaseFeeCents                Int   @default(0)
  entsorgungBaseFeeCents             Int   @default(0)
  montageStandardMultiplier          Float @default(1)
  montagePlusMultiplier              Float @default(1)
  montagePremiumMultiplier           Float @default(1)
  entsorgungStandardMultiplier       Float @default(1)
  entsorgungPlusMultiplier           Float @default(1)
  entsorgungPremiumMultiplier        Float @default(1)
  montageMinimumOrderCents           Int   @default(0)
  entsorgungMinimumOrderCents        Int   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ServiceModule {
  id          String            @id @default(cuid())
  slug        ServiceModuleSlug @unique
  nameDe      String
  descriptionDe String?
  active      Boolean           @default(true)
  sortOrder   Int               @default(0)
  deletedAt   DateTime?
  deletedBy   String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  options   ServiceOption[]
  promoRules PromoRule[]
}

model ServiceOption {
  id                  String                   @id @default(cuid())
  moduleId            String
  module              ServiceModule            @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  code                String                   @unique
  nameDe              String
  descriptionDe       String?
  pricingType         ServiceOptionPricingType @default(PER_UNIT)
  defaultPriceCents   Int
  defaultLaborMinutes Int                      @default(0)
  defaultVolumeM3     Float                    @default(0)
  requiresQuantity    Boolean                  @default(true)
  requiresPhoto       Boolean                  @default(false)
  isHeavy             Boolean                  @default(false)
  active              Boolean                  @default(true)
  sortOrder           Int                      @default(0)
  deletedAt           DateTime?
  deletedBy           String?
  version             Int                      @default(1)
  createdAt           DateTime                 @default(now())
  updatedAt           DateTime                 @updatedAt

  @@index([moduleId, active, sortOrder])
}

model PromoRule {
  id               String            @id @default(cuid())
  code             String            @unique
  moduleId         String?
  module           ServiceModule?    @relation(fields: [moduleId], references: [id], onDelete: SetNull)
  serviceTypeScope ServiceType?
  discountType     PromoDiscountType
  discountValue    Int
  minOrderCents    Int               @default(0)
  maxDiscountCents Int?
  validFrom        DateTime?
  validTo          DateTime?
  active           Boolean           @default(true)
  deletedAt        DateTime?
  deletedBy        String?
  version          Int               @default(1)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@index([active, code])
  @@index([moduleId, active])
}

model AvailabilityRule {
  id          String   @id @default(cuid())
  dayOfWeek   Int
  startTime   String
  endTime     String
  slotMinutes Int
  capacity    Int
  active      Boolean  @default(true)
  deletedAt   DateTime?
  deletedBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AvailabilityException {
  id               String   @id @default(cuid())
  date             DateTime @db.Date
  closed           Boolean  @default(false)
  overrideCapacity Int?
  note             String?
  deletedAt        DateTime?
  deletedBy        String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Order {
  id       String @id @default(cuid())
  publicId String @unique
  orderNo  String? @unique

  serviceType ServiceType
  speed       SpeedType
  status      OrderStatus @default(NEW)

  customerName      String
  customerPhone     String
  customerEmail     String
  contactPreference ContactPreference
  note              String?

  slotStart DateTime?
  slotEnd   DateTime?
  requestedDateFrom DateTime? @db.Date
  requestedDateTo DateTime? @db.Date
  preferredTimeWindow PreferredTimeWindow?
  scheduledAt DateTime?

  volumeM3      Float
  laborHours    Float
  distanceKm    Float?
  priceMinCents Int
  priceMaxCents Int

  wizardData Json
  deletedAt  DateTime?
  deletedBy  String?
  version    Int      @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lines        OrderLine[]
  serviceItems OrderServiceItem[]
  uploads      OrderUpload[]
  offer        Offer?
  quote        Quote?
  invoices     Invoice[]

  @@index([slotStart])
  @@index([requestedDateFrom])
  @@index([scheduledAt])
  @@index([status])
}

enum OrderServiceKind {
  UMZUG
  MONTAGE
  ENTSORGUNG
  SPECIAL
}

model OrderServiceItem {
  id String @id @default(cuid())

  orderId String
  order   Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  kind              OrderServiceKind
  moduleId          String?
  serviceOptionCode String?
  titleDe           String
  detailsJson       Json?
  qty               Int      @default(1)
  unit              String   @default("Pauschale")
  unitPriceCents    Int      @default(0)
  lineTotalCents    Int      @default(0)
  sortOrder         Int      @default(0)
  createdAt         DateTime @default(now())

  @@index([orderId, sortOrder])
  @@index([kind])
}

model OrderLine {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  catalogItemId String
  catalogItem   CatalogItem @relation(fields: [catalogItemId], references: [id])

  qty          Int
  unitVolumeM3 Float
  lineVolumeM3 Float
  isDisposal   Boolean @default(false)
}

model OrderUpload {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  fileName  String
  filePath  String
  mimeType  String
  sizeBytes Int
  createdAt DateTime @default(now())
}

model WhatsAppConversation {
  id          String   @id @default(cuid())
  phoneNumber String
  state       String
  data        Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([phoneNumber])
}

enum OfferStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum ContractStatus {
  PENDING_SIGNATURE
  SIGNED
  CANCELLED
}

enum QuoteStatus {
  QUOTE
  PENDING_SIGNATURE
  CONFIRMED
  SCHEDULED
  CANCELLED
  EXPIRED
}

enum QuoteSource {
  PREISE
}

enum QuoteServiceContext {
  MOVING
  MONTAGE
  ENTSORGUNG
  SPEZIALSERVICE
  COMBO
}

enum SignatureProvider {
  DOCUSIGN
  INTERNAL
}

enum DocumentScope {
  ORDER
  OFFER
  CONTRACT
}

model Offer {
  id      String @id @default(cuid())
  token   String @unique
  orderId String? @unique
  offerNo String? @unique

  order Order? @relation(fields: [orderId], references: [id], onDelete: Cascade)

  status OfferStatus @default(PENDING)

  customerName    String
  customerEmail   String
  customerPhone   String
  customerAddress String?

  moveFrom     String?
  moveTo       String?
  moveDate     DateTime?
  floorFrom    Int?
  floorTo      Int?
  elevatorFrom Boolean @default(false)
  elevatorTo   Boolean @default(false)
  notes        String?

  services Json

  netCents   Int
  vatCents   Int
  grossCents Int

  discountPercent Float?
  discountCents   Int?
  discountNote    String?
  customNote      String?
  isManual        Boolean @default(false)
  deletedAt       DateTime?
  deletedBy       String?
  version         Int      @default(1)

  pdfUrl String?

  validUntil DateTime
  expiresAt  DateTime

  acceptedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contract Contract?
  invoices Invoice[]

  @@index([token])
  @@index([status])
  @@index([expiresAt])
}

model Contract {
  id         String @id @default(cuid())
  offerId    String @unique
  contractNo String? @unique

  offer Offer @relation(fields: [offerId], references: [id], onDelete: Cascade)
  isManual     Boolean          @default(false)
  manualPayload Json?

  status            ContractStatus    @default(PENDING_SIGNATURE)
  signatureProvider SignatureProvider @default(DOCUSIGN)
  deletedAt         DateTime?
  deletedBy         String?
  version           Int               @default(1)

  docusignEnvelopeId String? @unique
  docusignStatus     String?

  contractPdfUrl String?
  signedPdfUrl   String?
  auditTrailUrl  String?

  signingUrl              String?
  signatureTokenHash      String?
  signatureTokenExpiresAt DateTime?
  fallbackSignedName      String?
  fallbackSignedAt        DateTime?
  fallbackSignerIp        String?
  fallbackSignerUserAgent String?
  fallbackAgbAccepted     Boolean   @default(false)
  signatureImageUrl       String?
  signedPdfSha256         String?
  sentForSigningAt        DateTime?
  signedAt                DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  invoices Invoice[]

  @@index([docusignEnvelopeId])
  @@index([status])
}

model Quote {
  id             String              @id @default(cuid())
  quoteId        String              @unique
  status         QuoteStatus         @default(QUOTE)
  source         QuoteSource         @default(PREISE)
  serviceContext QuoteServiceContext
  packageSpeed   SpeedType
  draftJson      Json
  resultJson     Json
  distanceKm     Float?
  driveCostCents Int?
  subtotalCents  Int
  priceMinCents  Int
  priceMaxCents  Int
  expiresAt      DateTime
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  orderId String? @unique
  order   Order?  @relation(fields: [orderId], references: [id], onDelete: SetNull)

  events QuoteEvent[]

  @@index([status])
  @@index([createdAt])
}

model QuoteEvent {
  id          String   @id @default(cuid())
  quoteRefId  String
  quote       Quote    @relation(fields: [quoteRefId], references: [id], onDelete: Cascade)
  eventType   String
  payloadJson Json?
  createdAt   DateTime @default(now())

  @@index([quoteRefId, createdAt])
}

model RouteDistanceCache {
  id             String   @id @default(cuid())
  fromPostalCode String
  toPostalCode   String
  profile        String   @default("driving-car")
  distanceKm     Float
  expiresAt      DateTime
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([fromPostalCode, toPostalCode, profile])
  @@index([expiresAt])
}

model DocumentSequence {
  id         String        @id @default(cuid())
  scope      DocumentScope
  timeBucket String
  counter    Int           @default(0)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  @@unique([scope, timeBucket])
  @@index([scope, timeBucket])
}

model MediaAsset {
  id        String   @id @default(cuid())
  filename  String
  path      String   @unique
  alt       String?
  title     String?
  mime      String
  size      Int
  width     Int?
  height    Int?
  deletedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  slots ContentSlot[]
  variants MediaAssetVariant[]
}

enum MediaVariantKind {
  hero
  gallery
  thumbnail
  custom
}

model MediaAssetVariant {
  id        String           @id @default(cuid())
  assetId    String
  asset      MediaAsset       @relation(fields: [assetId], references: [id], onDelete: Cascade)
  kind      MediaVariantKind
  path      String           @unique
  mimeType  String
  sizeBytes Int
  width     Int?
  height    Int?
  createdAt DateTime         @default(now())

  @@index([assetId])
  @@unique([assetId, kind])
}

model ContentSlot {
  id         String   @id @default(cuid())
  key        String   @unique
  type       String   @default("image")
  assetId    String?
  value      String?
  alt        String?
  meta       Json?
  updatedAt  DateTime @updatedAt
  createdAt  DateTime @default(now())

  asset     MediaAsset?       @relation(fields: [assetId], references: [id], onDelete: SetNull)
  revisions ContentRevision[]
}

model SlotRegistry {
  id             String   @id @default(cuid())
  key            String   @unique
  defaultPath    String
  discoveredFrom String
  usageType      String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model JobPosting {
  id           String   @id @default(cuid())
  title        String
  department   String?
  location     String   @default("Berlin")
  type         String   @default("Vollzeit")
  description  String   @db.Text
  requirements String?  @db.Text
  isActive     Boolean  @default(true)
  deletedAt    DateTime?
  deletedBy    String?
  version      Int      @default(1)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

enum InvoiceStatus {
  UNPAID
  PARTIAL
  PAID
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  BANK_TRANSFER
  CASH
  CARD
  PAYPAL
  OTHER
}

model Invoice {
  id        String @id @default(cuid())
  invoiceNo String? @unique

  companyId String?

  contractId String?
  contract   Contract? @relation(fields: [contractId], references: [id], onDelete: SetNull)

  offerId String?
  offer   Offer? @relation(fields: [offerId], references: [id], onDelete: SetNull)

  orderId String?
  order   Order? @relation(fields: [orderId], references: [id], onDelete: SetNull)

  isManual Boolean @default(false)

  customerName  String
  customerEmail String
  customerPhone String?
  address       String?

  description String? @db.Text
  lineItems   Json?

  discountPercent Float?
  discountCents   Int?
  notes           String? @db.Text

  issuedAt DateTime @default(now())
  dueAt    DateTime

  netCents   Int
  vatCents   Int
  grossCents Int

  paidCents Int @default(0)

  status InvoiceStatus @default(UNPAID)
  pdfUrl String?
  deletedAt DateTime?
  deletedBy String?
  version   Int      @default(1)

  items    InvoiceItem[]
  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([status])
  @@index([issuedAt])
  @@index([dueAt])
}

model InvoiceItem {
  id             String   @id @default(cuid())
  invoiceId      String
  invoice        Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  description    String
  quantity       Float    @default(1)
  unit           String   @default("St√ºck")
  unitPriceCents Int
  vatPercent     Float    @default(19)
  lineTotalCents Int
  sortOrder      Int      @default(0)

  createdAt      DateTime @default(now())

  @@index([invoiceId])
}

model Payment {
  id        String @id @default(cuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  amountCents Int
  method      PaymentMethod @default(BANK_TRANSFER)
  reference   String?
  paidAt      DateTime      @default(now())
  notes       String?

  createdAt DateTime @default(now())
}

model AdminUser {
  id                String   @id @default(cuid())
  email             String   @unique
  name              String
  passwordHash      String
  avatarUrl         String?
  isActive          Boolean  @default(true)
  failedLoginCount  Int      @default(0)
  lockedUntil       DateTime?
  lastLoginAt       DateTime?
  notifications     Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  deletedAt         DateTime?
  deletedBy         String?

  roles     UserRole[]
  auditLogs AuditLog[] @relation("AuditActor")
}

model Role {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users       UserRole[]
  permissions RolePermission[]
}

model Permission {
  id          String   @id @default(cuid())
  key         String   @unique
  label       String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roles RolePermission[]
}

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  roleId    String
  createdAt DateTime @default(now())
  deletedAt DateTime?

  user AdminUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
}

model RolePermission {
  id           String   @id @default(cuid())
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
}

model AuditLog {
  id          String   @id @default(cuid())
  actorUserId String?
  action      String
  entityType  String
  entityId    String?
  path        String?
  ip          String?
  userAgent   String?
  before      Json?
  after       Json?
  createdAt   DateTime @default(now())

  actor AdminUser? @relation("AuditActor", fields: [actorUserId], references: [id], onDelete: SetNull)

  @@index([entityType, entityId])
  @@index([createdAt])
}

model ContentRevision {
  id          String   @id @default(cuid())
  slotId      String
  editorEmail String?
  value       String?
  meta        Json?
  createdAt   DateTime @default(now())

  slot ContentSlot @relation(fields: [slotId], references: [id], onDelete: Cascade)

  @@index([slotId, createdAt])
}
